# ============================================================
# Fastfile - iOS App Store Connect ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–
# ============================================================

default_platform(:ios)

platform :ios do
  # ============================================================
  # äº‹å‰å‡¦ç†: è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  # ============================================================
  desc "è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸ"
  lane :sync_certificates do
    if is_ci
      # CIç’°å¢ƒç”¨: ä¸€æ™‚çš„ãªKeychainã‚’ä½œæˆ
      create_keychain(
        name: "ci_keychain",
        password: ENV["MATCH_PASSWORD"],
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
      
      match(
        git_url: "https://github.com/ryuya0124/Apple_Certificates",
        type: "appstore",
        readonly: true,
        keychain_name: "ci_keychain",
        keychain_password: ENV["MATCH_PASSWORD"]
      )
    else
      # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨: API Keyèªè¨¼ã‚’ä½¿ç”¨
      api_key = app_store_connect_api_key(
        key_id: "7LK8SRK8KU",
        issuer_id: "714bd8a7-7a2b-4efb-893d-c5eb74b71125",
        key_filepath: "/Users/ryuya/Documents/apple_cert/AuthKey_7LK8SRK8KU.p8"
      )
      
      match(
        git_url: "https://github.com/ryuya0124/Apple_Certificates",
        type: "appstore",
        readonly: true,
        api_key: api_key
      )
    end
  end

  # ============================================================
  # ç½²åã‚ã‚ŠIPAãƒ“ãƒ«ãƒ‰ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
  # ============================================================
  desc "ç½²åã‚ã‚ŠIPAã‚’ãƒ“ãƒ«ãƒ‰"
  lane :build_signed do
    # è¨¼æ˜æ›¸ã‚’åŒæœŸ
    sync_certificates

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # IPAã‚’ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Rytmica.ipa"
    )

    UI.success("ç½²åã‚ã‚ŠIPAãƒ“ãƒ«ãƒ‰å®Œäº†: build/ios/ipa/Rytmica.ipa")
  end

  # ============================================================
  # TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿IPAã‚’ä½¿ç”¨ï¼‰
  # ============================================================
  desc "ãƒ“ãƒ«ãƒ‰æ¸ˆã¿IPAã‚’TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :upload_testflight do
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆios/fastlane ã‹ã‚‰2éšå±¤ä¸Šï¼‰
    project_root = File.expand_path("../..", __dir__)
    pubspec_path = File.join(project_root, "pubspec.yaml")
    
    # pubspec.yamlã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    pubspec_content = File.read(pubspec_path)
    version_match = pubspec_content.match(/version:\s*(\d+\.\d+\.\d+)\+(\d+)/)
    
    if version_match
      version_name = version_match[1]
      build_number = version_match[2]
      UI.message("ğŸ“¦ pubspec.yaml ã‹ã‚‰å–å¾—: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ #{version_name}, ãƒ“ãƒ«ãƒ‰ç•ªå· #{build_number}")
    else
      version_name = "ä¸æ˜"
      build_number = "ä¸æ˜"
    end

    # App Store Connect APIèªè¨¼è¨­å®š
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: Base64.decode64(ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]),
      is_key_content_base64: false
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
    begin
      pilot(
        api_key: api_key,
        ipa: "../build/ios/ipa/Rytmica.ipa",
        skip_waiting_for_build_processing: true
      )
      UI.success("âœ… TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†")
    rescue => e
      error_msg = e.message.to_s
      if error_msg.include?("redundant binary upload") || 
         error_msg.include?("already exists") || 
         error_msg.include?("This build already exists") || 
         error_msg.include?("has already been uploaded") ||
         error_msg.include?("must be higher than") ||
         error_msg.include?("DUPLICATE") ||
         error_msg.include?("has already been used")
        UI.user_error!("âŒ ãƒ“ãƒ«ãƒ‰ç•ªå· #{build_number} ã¯æ—¢ã«TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ã™ï¼\n\n" \
          "ğŸ“ è§£æ±ºæ–¹æ³•: pubspec.yaml ã® version ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚\n" \
          "   ç¾åœ¨: version: #{version_name}+#{build_number}\n" \
          "   å¤‰æ›´ä¾‹: version: #{version_name}+#{build_number.to_i + 1}")
      else
        raise e
      end
    end
  end

  # ============================================================
  # ãƒ­ãƒ¼ã‚«ãƒ«ç”¨: TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿IPAã‚’ä½¿ç”¨ï¼‰
  # ============================================================
  desc "ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿IPAã‚’TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :upload_local do
    # ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã®App Store Connect APIèªè¨¼è¨­å®š
    api_key = app_store_connect_api_key(
      key_id: "7LK8SRK8KU",
      issuer_id: "714bd8a7-7a2b-4efb-893d-c5eb74b71125",
      key_filepath: "/Users/ryuya/Documents/apple_cert/AuthKey_7LK8SRK8KU.p8"
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    pilot(
      api_key: api_key,
      ipa: "../build/ios/ipa/Rytmica.ipa",
      skip_waiting_for_build_processing: true
    )

    UI.success("ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†")
  end

  # ============================================================
  # TestFlightã¸ã®ãƒ“ãƒ«ãƒ‰+ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ã®betaãƒ¬ãƒ¼ãƒ³ï¼‰
  # ============================================================
  desc "TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :beta do
    build_signed
    upload_testflight
  end

  # ============================================================
  # App Store Connectã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒªãƒªãƒ¼ã‚¹ç”¨ï¼‰
  # ============================================================
  desc "App Store Connectã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :release do
    beta
  end

  # ============================================================
  # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨: TestFlightã¸ã®ãƒ“ãƒ«ãƒ‰+ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  # ============================================================
  desc "ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :local_testflight do
    # è¨¼æ˜æ›¸ã‚’åŒæœŸ
    sync_certificates

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆios/fastlane ã‹ã‚‰2éšå±¤ä¸Šï¼‰
    project_root = File.expand_path("../..", __dir__)
    pubspec_path = File.join(project_root, "pubspec.yaml")
    
    # pubspec.yamlã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    pubspec_content = File.read(pubspec_path)
    version_match = pubspec_content.match(/version:\s*(\d+\.\d+\.\d+)\+(\d+)/)
    
    if version_match
      version_name = version_match[1]
      build_number = version_match[2]
      UI.message("ğŸ“¦ pubspec.yaml ã‹ã‚‰å–å¾—: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ #{version_name}, ãƒ“ãƒ«ãƒ‰ç•ªå· #{build_number}")
    else
      UI.user_error!("âŒ pubspec.yaml ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚version: X.Y.Z+N ã®å½¢å¼ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    end

    # pubspec.yamlã®ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’Info.plistã«ç›´æ¥è¨­å®šï¼ˆã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆãªã—ï¼‰
    update_info_plist(
      plist_path: "Runner/Info.plist",
      block: proc do |plist|
        plist["CFBundleVersion"] = build_number
        plist["CFBundleShortVersionString"] = version_name
      end
    )
    UI.message("ğŸ“ Info.plist ã‚’æ›´æ–°: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ #{version_name}, ãƒ“ãƒ«ãƒ‰ç•ªå· #{build_number}")

    # ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆé‡è¦: å¤ã„ãƒ“ãƒ«ãƒ‰çµæœã‚’ä½¿ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    UI.message("ğŸ§¹ ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ä¸­...")
    xcclean(scheme: "Runner")

    # IPAã‚’ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Rytmica.ipa",
      clean: true
    )

    # ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã®App Store Connect APIèªè¨¼è¨­å®š
    api_key = app_store_connect_api_key(
      key_id: "7LK8SRK8KU",
      issuer_id: "714bd8a7-7a2b-4efb-893d-c5eb74b71125",
      key_filepath: "/Users/ryuya/Documents/apple_cert/AuthKey_7LK8SRK8KU.p8"
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
    begin
      pilot(
        api_key: api_key,
        ipa: "../build/ios/ipa/Rytmica.ipa",
        skip_waiting_for_build_processing: true
      )
      UI.success("âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†")
    rescue => e
      error_msg = e.message.to_s
      if error_msg.include?("redundant binary upload") || 
         error_msg.include?("already exists") || 
         error_msg.include?("This build already exists") ||
         error_msg.include?("has already been uploaded") ||
         error_msg.include?("must be higher than") ||
         error_msg.include?("DUPLICATE") ||
         error_msg.include?("has already been used")
        UI.user_error!("âŒ ãƒ“ãƒ«ãƒ‰ç•ªå· #{build_number} ã¯æ—¢ã«TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ã™ï¼\n\n" \
          "ğŸ“ è§£æ±ºæ–¹æ³•: pubspec.yaml ã® version ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚\n" \
          "   ç¾åœ¨: version: #{version_name}+#{build_number}\n" \
          "   å¤‰æ›´ä¾‹: version: #{version_name}+#{build_number.to_i + 1}")
      else
        raise e
      end
    end
  end
end
