name: Multi-Platform Release Build

on:
  workflow_dispatch:  # 手動トリガーのみ

jobs:
  # ============================================================
  # Linux ビルド (x64 / ARM64)
  # ============================================================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Flutter SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
      
    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Generate l10n
      run: flutter gen-l10n

    - name: Build Linux x64
      run: flutter build linux --release

    - name: Package Linux x64
      run: |
        mkdir -p dist
        cp -r build/linux/x64/release/bundle dist/Rytmica-x64

    - name: Build Linux ARM64
      run: flutter build linux --release --target-platform linux-arm64 || echo "ARM64 build not supported"
      continue-on-error: true

    - name: Package Linux ARM64
      run: |
        if [ -d "build/linux/arm64/release/bundle" ]; then
          cp -r build/linux/arm64/release/bundle dist/Rytmica-arm64
        fi
      continue-on-error: true

    - name: Upload Linux x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: Rytmica-x64
        path: dist/Rytmica-x64

    - name: Upload Linux ARM64 artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('dist/Rytmica-arm64') != ''
      with:
        name: Rytmica-arm64
        path: dist/Rytmica-arm64

  # ============================================================
  # Android ビルド - ARM64のみ
  # ============================================================
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Cache Flutter SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'

    - name: Install dependencies
      run: flutter pub get

    - name: Generate l10n
      run: flutter gen-l10n

    - name: Build Android APK (ARM64 only)
      run: flutter build apk --release --target-platform android-arm64

    - name: Rename APK
      run: |
        # target-platformを指定してもapp-release.apkとして出力される場合があるため確認
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/Rytmica.apk
        elif [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
          mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk build/app/outputs/flutter-apk/Rytmica.apk
        else
          echo "APK file not found!"
          ls -R build/app/outputs/flutter-apk/
          exit 1
        fi

    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: rytmica-android
        path: build/app/outputs/flutter-apk/Rytmica.apk

  # ============================================================
  # Windows ビルド (x64 / ARM64 + MSIX)
  # ============================================================
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Flutter SDK
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Pub\Cache
          ~\.flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'

    - name: Install dependencies
      run: flutter pub get

    - name: Generate l10n
      run: flutter gen-l10n

    - name: Build Windows x64
      run: flutter build windows --release

    - name: Package Windows x64
      run: |
        mkdir -p dist
        xcopy /E /I /Y build\windows\x64\runner\Release dist\Rytmica-x64
      shell: cmd

    - name: Build Windows ARM64
      run: flutter build windows --release --target-platform windows-arm64
      continue-on-error: true

    - name: Package Windows ARM64
      run: |
        if (Test-Path "build\windows\arm64\runner\Release") {
          xcopy /E /I /Y build\windows\arm64\runner\Release dist\Rytmica-arm64
        }
      shell: powershell
      continue-on-error: true

    - name: Build Windows MSIX (Universal)
      run: dart run msix:create --build-windows false
      continue-on-error: true

    - name: Upload Windows x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: Rytmica-x64
        path: dist/Rytmica-x64

    - name: Upload Windows ARM64 artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('dist/Rytmica-arm64') != ''
      with:
        name: Rytmica-arm64
        path: dist/Rytmica-arm64

    - name: Upload Windows MSIX artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('build/windows/**/*.msix') != ''
      with:
        name: rytmica-windows-msix
        path: build/windows/**/*.msix

