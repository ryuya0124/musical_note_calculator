name: Flutter iOS Build

on:
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'TestFlightにアップロードする'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  # ============================================================
  # Job 1: 署名なしIPAビルド
  # ============================================================
  build-unsigned:
    name: 署名なしIPAビルド
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Flutter SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'

    - name: Install dependencies
      run: flutter pub get

    - name: Build iOS app (no codesign)
      run: flutter build ios --release --no-codesign

    - name: Create unsigned IPA
      run: |
        mkdir -p build/ios/ipa/Payload
        cp -r build/ios/iphoneos/Runner.app build/ios/ipa/Payload/
        cd build/ios/ipa
        zip -r musical_note_calculator_unsigned.ipa Payload
        rm -rf Payload

    - name: Upload unsigned IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: musical-note-calculator-unsigned.ipa
        path: build/ios/ipa/musical_note_calculator_unsigned.ipa
        if-no-files-found: warn

  # ============================================================
  # Job 2: 署名ありIPAビルド + TestFlightアップロード（選択式）
  # ============================================================
  build-signed-and-upload:
    name: 署名ありIPAビルド & TestFlightアップロード
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Flutter SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ~/.flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'

    - name: Install dependencies
      run: flutter pub get

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: false

    - name: Install Fastlane
      run: |
        cd ios
        gem install bundler -v 2.5.0
        bundle config set --local path 'vendor/bundle'
        bundle install

    - name: Setup Git and Match credentials
      env:
        MATCH_GIT_TOKEN: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        # GitHubユーザー名とトークンを組み合わせる
        GITHUB_USERNAME="ryuya0124"
        MATCH_GIT_BASIC_AUTHORIZATION_PLAIN="${GITHUB_USERNAME}:${MATCH_GIT_TOKEN}"
        # デバッグ: 認証情報の長さを確認（セキュリティのため実際の値は表示しない）
        echo "Auth plain length: ${#MATCH_GIT_BASIC_AUTHORIZATION_PLAIN}"
        # Git認証情報を設定（プレーンテキスト形式: username:token）
        echo "https://${MATCH_GIT_BASIC_AUTHORIZATION_PLAIN}@github.com" > ~/.git-credentials
        git config --global credential.helper store
        # Fastlane Match用にBase64エンコードした認証情報を環境変数に設定
        MATCH_GIT_BASIC_AUTHORIZATION_BASE64=$(echo -n "${MATCH_GIT_BASIC_AUTHORIZATION_PLAIN}" | base64)
        echo "Auth base64 length: ${#MATCH_GIT_BASIC_AUTHORIZATION_BASE64}"
        echo "MATCH_GIT_BASIC_AUTHORIZATION=${MATCH_GIT_BASIC_AUTHORIZATION_BASE64}" >> $GITHUB_ENV

    - name: Build signed IPA with Fastlane
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        # デバッグ: 環境変数の確認
        echo "MATCH_GIT_BASIC_AUTHORIZATION length: ${#MATCH_GIT_BASIC_AUTHORIZATION}"
        # GitHubユーザー名とトークンを組み合わせる
        GITHUB_USERNAME="ryuya0124"
        MATCH_GIT_BASIC_AUTHORIZATION_PLAIN="${GITHUB_USERNAME}:${MATCH_GIT_BASIC_AUTHORIZATION}"
        # Fastlane Match用にBase64エンコード
        export MATCH_GIT_BASIC_AUTHORIZATION=$(echo -n "${MATCH_GIT_BASIC_AUTHORIZATION_PLAIN}" | base64)
        echo "Final auth base64 length: ${#MATCH_GIT_BASIC_AUTHORIZATION}"
        cd ios
        bundle exec fastlane build_signed

    - name: Upload signed IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: musical-note-calculator-signed.ipa
        path: build/ios/ipa/musical_note_calculator.ipa
        if-no-files-found: warn

    - name: Upload to TestFlight
      if: ${{ inputs.upload_to_testflight == 'true' }}
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        cd ios
        bundle exec fastlane upload_testflight
